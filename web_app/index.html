<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>ExcelSlimmer (Web Version)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f3f4f6;
        --card-bg: #ffffff;
        --border: #d1d5db;
        --accent: #2563eb;
        --accent-soft: #dbeafe;
        --text-main: #111827;
        --text-muted: #6b7280;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #111827;
          --card-bg: #111827;
          --border: #1f2937;
          --accent: #60a5fa;
          --accent-soft: #1d4ed8;
          --text-main: #f9fafb;
          --text-muted: #9ca3af;
        }
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text-main);
      }
      .shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header {
        padding: 16px 20px 8px;
      }
      .title {
        font-size: 20px;
        font-weight: 700;
      }
      .subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
      }
      main {
        flex: 1;
        display: flex;
        justify-content: center;
        padding: 0 16px 24px;
      }
      .card {
        width: 100%;
        max-width: 820px;
        margin-top: 12px;
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 20px 20px 16px;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      }
      .card-grid {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
        gap: 16px;
      }
      @media (max-width: 800px) {
        .card-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }
      .section-title {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .field-label {
        font-size: 12px;
        margin-bottom: 4px;
      }
      .file-drop {
        border-radius: 8px;
        border: 1px dashed var(--border);
        padding: 14px 12px;
        background: rgba(148, 163, 184, 0.04);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .file-drop-main {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .file-name {
        font-size: 13px;
        font-weight: 500;
      }
      .file-hint {
        font-size: 11px;
        color: var(--text-muted);
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        border: 1px solid transparent;
        padding: 7px 14px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        cursor: pointer;
        background: var(--accent);
        color: #ffffff;
        transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
      }
      .btn-outline {
        background: transparent;
        color: var(--accent);
        border-color: var(--accent);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
      }
      .btn:not(:disabled):hover {
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
        transform: translateY(-1px);
      }
      .btn:not(:disabled):active {
        box-shadow: none;
        transform: translateY(0);
      }
      .options-group {
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        background: rgba(148, 163, 184, 0.03);
      }
      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
      }
      .checkbox-row input[type="checkbox"] {
        width: 14px;
        height: 14px;
        cursor: pointer;
      }
      .hint {
        font-size: 11px;
        color: var(--text-muted);
      }
      .hint-warning {
        color: #dc2626;
      }
      .run-row {
        margin-top: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .status-text {
        font-size: 12px;
        color: var(--text-muted);
      }
      .progress-track {
        margin-top: 8px;
        width: 100%;
        height: 6px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.25);
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        width: 0;
        border-radius: inherit;
        background: var(--accent);
        transition: width 0.2s ease;
      }
      .log-area {
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 8px 10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.85);
        color: #e5e7eb;
        min-height: 140px;
        max-height: 260px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .log-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 12px;
        margin-bottom: 6px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 10px;
        background: var(--accent-soft);
        color: var(--accent);
      }
      footer {
        padding: 8px 20px 16px;
        font-size: 11px;
        color: var(--text-muted);
        text-align: right;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="title">ExcelSlimmer (Web Version)</div>
      </header>
      <main>
        <div class="card">
          <div class="card-grid">
            <section>
              <div class="section-title">대상 파일</div>
              <div class="file-drop">
                <div class="file-drop-main">
                  <div class="file-name" id="file-label">파일을 선택하거나 여기에 드롭하세요</div>
                  <div class="file-hint">지원 형식: .xlsx, .xlsm (최대 수십 MB 권장)</div>
                </div>
                <button class="btn-outline btn" id="pick-file">파일 선택</button>
                <input type="file" id="file-input" accept=".xlsx,.xlsm" hidden />
              </div>

              <div style="margin-top: 18px">
                <div class="section-title">실행할 기능</div>
                <div class="options-group">
                  <label class="checkbox-row">
                    <input type="checkbox" id="use-clean" checked />
                    <span>이름 정의 정리 (definedNames 클린)</span>
                  </label>
                  <label class="checkbox-row">
                    <input type="checkbox" id="use-image" checked />
                    <span>이미지 최적화 (이미지 리사이즈/압축)</span>
                  </label>
                  <label class="checkbox-row">
                    <input type="checkbox" id="use-precision" />
                    <span>정밀 슬리머 (Precision Plus)</span>
                  </label>
                  <div class="hint hint-warning">
                    ※ 정밀 슬리머 사용 시 일부 파일에서 Excel이 복구 여부를 물어볼 수 있습니다.
                  </div>
                </div>
              </div>

              <div style="margin-top: 14px">
                <div class="section-title">정밀 슬리머 옵션</div>
                <div class="options-group" id="precision-options" style="opacity: 0.45; pointer-events: none">
                  <label class="checkbox-row">
                    <input type="checkbox" id="opt-xmlcleanup" />
                    <span>XML 정리 (calcChain, printerSettings 등)</span>
                  </label>
                  <label class="checkbox-row">
                    <input type="checkbox" id="opt-force-custom" />
                    <span>숨은 XML 데이터 삭제 (customXml, 주의)</span>
                  </label>
                  <label class="checkbox-row">
                    <input type="checkbox" id="opt-aggressive" />
                    <span>이미지 포맷 변경 (PNG→JPG) + 참조 동기화 (고급)</span>
                  </label>
                  <div class="hint hint-warning">
                    ※ 숨은 XML 데이터 삭제 옵션은 일반적인 경우 사용하지 않는 것을 권장합니다.
                  </div>
                </div>
              </div>

              <div class="run-row">
                <button class="btn" id="run-btn">슬리머 실행</button>
                <div class="status-text" id="status">준비됨</div>
              </div>
              <div class="progress-track">
                <div class="progress-bar" id="progress-bar"></div>
              </div>
            </section>

            <section>
              <div class="log-header">
                <div class="section-title" style="margin-bottom: 0">로그</div>
                <span class="badge">읽기 전용 로그</span>
              </div>
              <div id="log" class="log-area">실행 로그가 여기에 표시됩니다.</div>
            </section>
          </div>
        </div>
      </main>
      <footer>ExcelSlimmer · Web Frontend</footer>
    </div>

    <script>
      const fileInput = document.getElementById("file-input");
      const pickFileBtn = document.getElementById("pick-file");
      const fileLabel = document.getElementById("file-label");
      const runBtn = document.getElementById("run-btn");
      const statusEl = document.getElementById("status");
      const progressBar = document.getElementById("progress-bar");
      const logEl = document.getElementById("log");

      const useClean = document.getElementById("use-clean");
      const useImage = document.getElementById("use-image");
      const usePrecision = document.getElementById("use-precision");
      const precisionOptions = document.getElementById("precision-options");
      const optXml = document.getElementById("opt-xmlcleanup");
      const optForceCustom = document.getElementById("opt-force-custom");
      const optAggressive = document.getElementById("opt-aggressive");

      let selectedFile = null;

      function setStatus(text, progress) {
        statusEl.textContent = text;
        if (typeof progress === "number") {
          const pct = Math.max(0, Math.min(100, progress));
          progressBar.style.width = pct + "%";
        }
      }

      function appendLog(line) {
        if (!line) return;
        if (logEl.textContent.trim() === "실행 로그가 여기에 표시됩니다.") {
          logEl.textContent = "";
        }
        logEl.textContent += line + "\n";
        logEl.scrollTop = logEl.scrollHeight;
      }

      // 파일 선택 버튼
      pickFileBtn.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (file) {
          selectedFile = file;
          fileLabel.textContent = file.name;
        }
      });

      // 드래그 앤 드롭 (카드 영역 전체)
      const dropZone = document.querySelector(".file-drop");
      ;["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });
      ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(eventName, () => {
          dropZone.style.borderColor = "var(--accent)";
        });
      });
      ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, () => {
          dropZone.style.borderColor = "var(--border)";
        });
      });
      dropZone.addEventListener("drop", (e) => {
        const dt = e.dataTransfer;
        const file = dt.files && dt.files[0];
        if (file) {
          selectedFile = file;
          fileLabel.textContent = file.name;
        }
      });

      // 정밀 슬리머 옵션 enable/disable
      function updatePrecisionOptions() {
        const enabled = usePrecision.checked;
        precisionOptions.style.opacity = enabled ? "1" : "0.45";
        precisionOptions.style.pointerEvents = enabled ? "auto" : "none";
      }
      usePrecision.addEventListener("change", updatePrecisionOptions);
      updatePrecisionOptions();

      async function runSlimmer() {
        if (!selectedFile) {
          alert("먼저 대상 엑셀 파일을 선택해 주세요.");
          return;
        }

        runBtn.disabled = true;
        setStatus("업로드 및 처리 중...", 5);
        appendLog("[INFO] 요청 시작: " + selectedFile.name);

        try {
          const formData = new FormData();
          formData.append("file", selectedFile);
          formData.append("use_clean", useClean.checked ? "true" : "false");
          formData.append("use_image", useImage.checked ? "true" : "false");
          formData.append("use_precision", usePrecision.checked ? "true" : "false");
          formData.append("aggressive", optAggressive.checked ? "true" : "false");
          formData.append("do_xml_cleanup", optXml.checked ? "true" : "false");
          formData.append("force_custom", optForceCustom.checked ? "true" : "false");

          const resp = await fetch("/api/slim", {
            method: "POST",
            body: formData,
          });

          if (!resp.ok) {
            let detail = "서버 오류가 발생했습니다.";
            try {
              const data = await resp.json();
              if (data && data.detail) detail = data.detail;
            } catch (_) {}
            appendLog("[ERROR] " + detail);
            setStatus("실패", 0);
            alert(detail);
            return;
          }

          // 성공 시: 파일 다운로드 처리
          const blob = await resp.blob();
          const contentDisposition = resp.headers.get("Content-Disposition") || "";
          let filename = selectedFile.name.replace(/\.xlsx$/i, "_complete.xlsx").replace(/\.xlsm$/i, "_complete.xlsm");
          const match = /filename="?([^";]+)"?/i.exec(contentDisposition);
          if (match && match[1]) {
            filename = decodeURIComponent(match[1]);
          }

          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);

          appendLog("[INFO] 완료: 결과 파일 다운로드 시작");
          setStatus("완료", 100);
        } catch (err) {
          console.error(err);
          appendLog("[ERROR] 네트워크 오류 또는 예기치 못한 오류가 발생했습니다.");
          setStatus("실패", 0);
          alert("네트워크 오류 또는 서버 오류가 발생했습니다.");
        } finally {
          runBtn.disabled = false;
        }
      }

      runBtn.addEventListener("click", () => {
        runSlimmer();
      });
    </script>
  </body>
</html>
